---
title: "Crime Modeling"
author: "Erin Franke"
date: "2022-10-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This is the 7th file in my honors project and creates Poisson regression models for Minneapolis and Saint Paul crime. \

```{r}
library(tidyverse)
library(sf)
library(spdep)
```

## Minneapolis modeling

```{r}
load("Data/CrimeCleaned/tract_aggregated_minneapolis.RData")
load("Data/CrimeCleaned/tract_aggregated_sp.RData")
load("Data/CrimeCleaned/tract_aggregated_no_auto.RData")
```

```{r}
crimes_wide_minn <- tract_aggregated %>%
  st_drop_geometry() %>%
  pivot_wider(id_cols = c(tractmod:canGent_gentrified),names_from = year, values_from = c(Theft, Violent, violent_per_1000, theft_per_1000))
crimes_wide_minn$canGent_gentrified <- relevel(crimes_wide_minn$canGent_gentrified, ref = "Could, but didn't gentrify")

crimes_wide_no_auto <- tract_aggregated_no_auto %>%
  st_drop_geometry() %>%
  pivot_wider(id_cols = c(tractmod:canGent_gentrified),names_from = year, values_from = c(Theft, Violent))
crimes_wide_no_auto$canGent_gentrified <- relevel(crimes_wide_no_auto$canGent_gentrified, ref = "Could, but didn't gentrify")

crimes_wide_sp <- tract_aggregated_sp %>%
  st_drop_geometry() %>%
  pivot_wider(id_cols = c(tractmod:canGent_gentrified),names_from = year, values_from = c(Theft, Violent, violent_per_1000, theft_per_1000))
crimes_wide_sp$canGent_gentrified <- relevel(crimes_wide_sp$canGent_gentrified, ref = "Could, but didn't gentrify")
```


### Violent crimes in Minneapolis

```{r}
var(crimes_wide_minn$Violent_2020)
mean(crimes_wide_minn$Violent_2020)

var(crimes_wide_minn$Theft_2020)
mean(crimes_wide_minn$Theft_2020)

crimes_wide_minn %>%
  select(tractmod, Violent_2020, Theft_2020) %>%
  rename("Theft" = "Theft_2020", 
         "Violent" = "Violent_2020") %>%
  pivot_longer(cols = c(Theft, Violent), names_to = "crime_type", values_to = "Count") %>%
  ggplot(aes(x=Count))+
  geom_density()+
  facet_wrap(~crime_type, scales = "free")+
  theme_classic()+
  theme(strip.background = element_blank(), 
        strip.text = element_text(family = "mono", face = "bold"),
        plot.title.position = "plot", 
        plot.title = element_text(family = "mono", size =10), 
        axis.text = element_text(family = "mono"),
        axis.title = element_text(family = "mono"))+
  labs(title = "Distribution of 2020 crimes for 115 Minneapolis census tracts", x="Number of crimes", y = "Density")
```

```{r}
minn_violent19 <- glm(Violent_2019 ~ canGent_gentrified + Violent_2010 + offset(log(population_2020)),
    data = crimes_wide_minn, family = poisson(link=log))
summary(minn_violent19)

minn_violent20 <- glm(Violent_2020 ~ canGent_gentrified + Violent_2010 + offset(log(population_2020)),
    data = crimes_wide_minn, family = poisson(link=log))
summary(minn_violent20)

minn_violent22 <- glm(Violent_2022 ~ canGent_gentrified + Violent_2010 + offset(log(population_2020)),
    data = crimes_wide_minn, family = poisson(link=log))
summary(minn_violent22)
```

Models with quasipoisson

```{r}
violent20_quasi <- glm(Violent_2020 ~ canGent_gentrified + Violent_2010 + offset(log(population_2020)),
    data = crimes_wide_minn, family =poisson(link=log))
summary(violent20_quasi)
```


#### Check residuals for spatial autocorrelation

```{r}
Rook <- poly2nb(min, queen = FALSE)
min$residuals <- resid(minn_violent20)
min %>%
  ggplot()+
  geom_sf(aes(fill = residuals))+
  scale_fill_gradient2(mid = "white", high = "red", low = "blue")+
  theme_classic()+
  theme(axis.text = element_blank(), 
        axis.ticks = element_blank(), 
        axis.line = element_blank(), 
        plot.title.position = "plot", 
        plot.title = element_text(family = "mono"), 
        legend.text = element_text(family = "mono"), 
        legend.title = element_text(family = "mono"))+
  labs(title = "Poisson Residuals: Minneapolis Violent Crime", fill = "Residual")

spdep::moran.test(min$residuals, nb2listw(Rook, style = "B"), randomisation = FALSE, alternative = "two.sided")
```


### Theft in Minneapolis 

```{r}
minn_theft19 <- glm(Theft_2019 ~ canGent_gentrified + Theft_2010 + offset(log(population_2020)),
    data = crimes_wide_minn, family = poisson(link=log))
summary(minn_theft19)

minn_theft22 <- glm(Theft_2022 ~ canGent_gentrified + Theft_2010 + offset(log(population_2020)),
    data = crimes_wide_minn, family = poisson(link=log))
summary(minn_theft22)
```

### Theft in Minneapolis without Autotheft

```{r}
minn_theft19_na <- glm(Theft_2019 ~ canGent_gentrified + Theft_2010 + offset(log(population_2020)),
    data = crimes_wide_no_auto, family = poisson(link=log))
summary(minn_theft19_na)

minn_theft20_na <- glm(Theft_2020 ~ canGent_gentrified + Theft_2010 + offset(log(population_2020)),
    data = crimes_wide_no_auto, family = poisson(link=log))
summary(minn_theft20_na)

minn_theft22_na <- glm(Theft_2022 ~ canGent_gentrified + Theft_2010 + offset(log(population_2020)),
    data = crimes_wide_no_auto, family = poisson(link=log))
summary(minn_theft22_na)
```

## Saint Paul Models

### Violent Crimes 

```{r}
sp_violent19 <- glm(Violent_2019 ~ canGent_gentrified + Violent_2015 + offset(log(population_2020)),
    data = crimes_wide_sp, family = poisson(link=log))
summary(sp_violent19)

sp_violent20 <- glm(Violent_2020 ~ canGent_gentrified + Violent_2015 + offset(log(population_2020)),
    data = crimes_wide_sp, family = poisson(link=log))
summary(sp_violent20)

sp_violent22 <- glm(Violent_2022 ~ canGent_gentrified + Violent_2015 + offset(log(population_2020)),
    data = crimes_wide_sp, family = poisson(link=log))
summary(sp_violent22)
```

### Theft

```{r}
sp_theft19 <- glm(Theft_2019 ~ canGent_gentrified + Theft_2015 + offset(log(population_2020)),
    data = crimes_wide_sp, family = poisson(link=log))
summary(sp_theft19)

sp_theft20 <- glm(Theft_2020 ~ canGent_gentrified + Theft_2015 + offset(log(population_2020)),
    data = crimes_wide_sp, family = poisson(link=log))
summary(sp_theft20)

sp_theft22 <- glm(Theft_2022 ~ canGent_gentrified + Theft_2015 + offset(log(population_2020)),
    data = crimes_wide_sp, family = poisson(link=log))
summary(sp_theft22)
```


```{r}
library(stargazer)
stargazer(minn1, minn2, minn3, minn4, title="Table 1: Minneapolis Overall Crime Models", type="latex", align=TRUE, dep.var.labels = "2019 crime rate", covariate.labels=c("Cannot Gentrify","Gentrified", "2010-2011 Crime Rate","2010 Population"), column.labels = c("Combined", "Freeman", "Ding", "PEW"), no.space=TRUE, report=("vc*p"))
```
