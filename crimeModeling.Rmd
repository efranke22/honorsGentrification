---
title: "Crime Modeling"
author: "Erin Franke"
date: "2022-10-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
load("Data/CrimeCleaned/tract_aggregated_minneapolis.RData")
load("Data/CrimeCleaned/tract_aggregated_sp.RData")
load("Data/CrimeCleaned/tract_points_sp.RData")
load("Data/CrimeCleaned/tract_aggregated_minneapolis_violent.RData")

library(tidyverse)
library(sf)

crimes_wide_minn <- tract_aggregated %>%
  mutate(crimes_per_1000 = round(crimes_per_1000, 0)) %>%
  st_drop_geometry() %>%
  mutate(crimes_per_1000 = case_when(is.na(crimes_per_1000) ~ 0, 
                                     TRUE ~ crimes_per_1000)) %>%
  pivot_wider(id_cols = c(tract:canGent_gentrified),names_from = year, values_from = crimes_per_1000) %>%
  mutate(avg2010to2015 = (`2010` + `2011` + `2012` + `2013` + `2014` + `2015`)/6) %>%
  mutate(city = "Minneapolis")

crimes_wide_minn$canGent_gentrified <- relevel(crimes_wide_minn$canGent_gentrified, ref = "1")

crimes_wide_sp <- tract_aggregated_sp %>%
  mutate(crimes_per_1000 = round(crimes_per_1000, 0)) %>%
  st_drop_geometry() %>%
  mutate(crimes_per_1000 = case_when(is.na(crimes_per_1000) ~ 0, 
                                     TRUE ~ crimes_per_1000)) %>%
  pivot_wider(id_cols = c(tractmod:canGent_gentrified),names_from = year, values_from = crimes_per_1000) %>%
  mutate(city = "Saint Paul")

crimes_wide_sp$canGent_gentrified <- relevel(crimes_wide_sp$canGent_gentrified, ref = "1")
```

```{r}
cw_sp_small <- crimes_wide_sp %>%
  select(tractmod, canGent_gentrified, population_2010, `2015`, `2021`, city)
cw_minn_small <- crimes_wide_minn %>%
  select(tract, canGent_gentrified, population_2010, `2015`, `2021`, city) %>%
  rename("tractmod" = "tract")
crimes_wide_all <- bind_rows(cw_sp_small, cw_minn_small)
```


Models predicting 2022 crime controlling for 2010-2015 crime rate:

```{r}
mod1 = glm(`2021` ~ canGent_gentrified + avg2010to2015, data = crimes_wide_minn, family = "poisson")
summary(mod1)

mod1_sp = glm(`2021` ~ canGent_gentrified + `2015`, data = crimes_wide_sp, family = "poisson")
summary(mod1_sp)

mod1_all = glm(`2021` ~ canGent_gentrified + `2015`, data = crimes_wide_all, family = "poisson")
summary(mod1_all)
```

Models predicting 2022 crime controlling for 2010-2015 crime rate and population:

```{r}
mod2 = glm(`2021` ~ canGent_gentrified + avg2010to2015 + population_2010, data = crimes_wide_minn, family = "poisson")
summary(mod2)

mod3 = glm(`2021` ~ canGent_gentrified + `2015` + population_2010, data = crimes_wide_minn, family = "poisson")
summary(mod3)

mod2_sp = glm(`2021` ~ canGent_gentrified + `2015` + population_2010, data = crimes_wide_sp, family = "poisson")
summary(mod2_sp)

mod2_all = glm(`2021` ~ canGent_gentrified * city + `2015` + population_2010, data = crimes_wide_all, family = "poisson")
summary(mod2_all)
```

```{r}
crimes_wide_all %>%
  ggplot(aes(x=canGent_gentrified, y=(`2021`-`2015`), color = city))+
  geom_boxplot()
```


Models predicting violent crime:

```{r}
crimes_wide_violent <- tract_aggregated_violent %>%
  mutate(crimes_per_1000 = round(crimes_per_1000, 0)) %>%
  st_drop_geometry() %>%
  pivot_wider(id_cols = c(tractmod, canGent_gentrified, population_2010),names_from = year, values_from = crimes_per_1000) %>%
  mutate(avg2010to2015 = (`2010` + `2011` + `2012` + `2013` + `2014` + `2015`)/6)

crimes_wide_violent$canGent_gentrified <- relevel(crimes_wide_violent$canGent_gentrified, ref = "1")

mod4 = glm(`2021` ~ canGent_gentrified + avg2010to2015 + population_2010, data = crimes_wide_violent, family = "poisson")
summary(mod4)
```


Models predicting non-violent crime:

```{r}
crimes_wide_theft <- tract_aggregated_theft %>%
  mutate(crimes_per_1000 = round(crimes_per_1000, 0)) %>%
  st_drop_geometry() %>%
  pivot_wider(id_cols = c(tract:ding),names_from = year, values_from = crimes_per_1000) %>%
  replace(is.na(.), 0) %>%
  mutate(avg2010to2015 = (`2010` + `2011` + `2012` + `2013` + `2014` + `2015`)/6)

mod4 = glm(`2021` ~ ding + canGent + avg2010to2015 + population_2010, data = crimes_wide_theft, family = "poisson")
summary(mod4)

mod4b = glm(`2021` ~ freeman + canGent + avg2010to2015 + population_2010, data = crimes_wide_theft, family = "poisson")
summary(mod4b)
```

X Create variable that combines canGent and gentrifed (0, 1, 2) \
X Get a third method for defining gentrification
**Combine crime data and run msp together**
**Finish address cleanup for msp** 
**Investigate discrepancies between freeman and ding and new method** 
**Spatial modeling!** 
