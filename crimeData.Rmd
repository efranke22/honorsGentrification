---
title: "Crime Data Cleaning"
author: "Erin Franke"
date: "2022-09-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This file shows my process for downloading and cleaning Minneapolis crime data.

## Data and library loading

```{r}
# Libraries
library(tidyverse)
library(sf)
library(stringr)
library(NatParksPalettes)
```

Create Minneapolis crime file from 2010 to September 2022.

```{r, eval=FALSE}
# Minneapolis crime 
minneapolisCrime2010 <- read_csv("Data/Crime/Police_Incidents_2010.csv") %>%
  select(ReportedDate, Offense, Description, Lat, Long)
minneapolisCrime2011 <- read_csv("Data/Crime/Police_Incidents_2011.csv") %>%
  select(ReportedDate, Offense, Description, Lat, Long)
minneapolisCrime2012 <- read_csv("Data/Crime/Police_Incidents_2012.csv") %>%
  select(ReportedDate, Offense, Description, Lat, Long)
minneapolisCrime2013 <- read_csv("Data/Crime/Police_Incidents_2013.csv") %>%
  select(ReportedDate, Offense, Description, Lat, Long)
minneapolisCrime2014 <- read_csv("Data/Crime/Police_Incidents_2014.csv") %>%
  select(ReportedDate, Offense, Description, Lat, Long)
minneapolisCrime2015 <- read_csv("Data/Crime/Police_Incidents_2015.csv") %>%
  select(ReportedDate, Offense, Description, Lat, Long)
minneapolisCrime2016 <- read_csv("Data/Crime/Police_Incidents_2016.csv") %>%
  select(ReportedDate, Offense, Description, Lat, Long)
minneapolisCrime2017 <- read_csv("Data/Crime/Police_Incidents_2017.csv") %>%
  select(ReportedDate, Offense, Description, Lat, Long)
minneapolisCrime2018a <- read_csv("Data/Crime/Police_Incidents_2018_PIMS.csv") %>%
  select(reportedDate, offense, description, centerLat, centerLong) %>%
  rename("ReportedDate" = "reportedDate", 
         "Offense" = "offense", 
         "Description" = "description", 
         "Lat" = "centerLat", 
         "Long" = "centerLong")
minneapolisCrime2018b <- read_csv("Data/Crime/Police_Incidents_2018.csv") %>%
  select(ReportedDate, Offense, Description, Lat, Long)
minneapolisCrime2019 <- read_csv("Data/Crime/Police_Incidents_2019.csv") %>%
  select(reportedDate, offense, description, centerLat, centerLong) %>%
  rename("ReportedDate" = "reportedDate", 
         "Offense" = "offense", 
         "Description" = "description", 
         "Lat" = "centerLat", 
         "Long" = "centerLong")
minneapolisCrime2020 <- read_csv("Data/Crime/Police_Incidents_2020.csv") %>%
  select(reportedDate, offense, description, centerLat, centerLong) %>%
  rename("ReportedDate" = "reportedDate", 
         "Offense" = "offense", 
         "Description" = "description", 
         "Lat" = "centerLat", 
         "Long" = "centerLong")
minneapolisCrime2021 <- read_csv("Data/Crime/Police_Incidents_2021.csv") %>%
  select(reportedDate, offense, description, centerLat, centerLong) %>%
  rename("ReportedDate" = "reportedDate", 
         "Offense" = "offense", 
         "Description" = "description", 
         "Lat" = "centerLat", 
         "Long" = "centerLong")
minneapolisCrime2022 <- read_csv("Data/Crime/Police_Incidents_2022.csv") %>%
  select(reportedDate, offense, description, centerLat, centerLong) %>%
  rename("ReportedDate" = "reportedDate", 
         "Offense" = "offense", 
         "Description" = "description", 
         "Lat" = "centerLat", 
         "Long" = "centerLong")

minneapolisCrime <- bind_rows(minneapolisCrime2010, minneapolisCrime2011, minneapolisCrime2012, minneapolisCrime2013, minneapolisCrime2014, minneapolisCrime2015, minneapolisCrime2016, minneapolisCrime2017, minneapolisCrime2018a, minneapolisCrime2018b, minneapolisCrime2019, minneapolisCrime2020, minneapolisCrime2021, minneapolisCrime2022) %>%
  mutate(year = as.numeric(substr(ReportedDate, 1, 4)), 
         date = as.Date.character(ReportedDate, format = "%Y/%m/%d"))

save(minneapolisCrime, file = "Data/Crime/minneapolisCrime.RData")
```

Load Saint Paul crime, Minneapolis crime, and gentrification file.

```{r}
# Saint Paul crime 
saintpaulcrime <- read_csv("Data/Crime/Crime_Incident_Report.csv")

# Minneapolis Crime
load("Data/Crime/minneapolisCrime.RData")

# Gentrification Information
load('Data/tractData/cleaned/gent_clean.RData')
```

## Clean Minneapolis crime data

Goal: aggregate these points by census tract based on latitude and longitude and plot them using the final census tracts from the cleaned gentrification file. 

First, assign each crime to a category of violent crime versus theft. The following 413 crimes were not placed in a category: COMPUT, JHOMIC, NOPAY, ONLTHT, WLKOFF

```{r}
minneapolisCrime <- minneapolisCrime %>%
  filter(year != 2023) %>%
  mutate(offenseCat = case_when(Offense %in% c("THEFT", "TFMV", "BURGD", "AUTOTH", "BURGB", "BIKETF", "TMVP", "THFTSW", "SHOPLF", "TFPER", "TBLDG", "CARJCK", "MVTHFT", "COINOP", "SCRAP", "POCKET", "PETIT", "PKGTHEFT", "LOOT") ~ "Theft", 
                   Offense %in% c("ASLT2", "ROBPER", "CSCR", "DASTR", "DASLT2", "ASLT3", "ROBBIZ", "ROBPAG", "ARSON", "ASLT4", "DASLT3", "MURDR", "ASLT1", "ADLTTN", "DASLT1", "DISARM", "ABSVAR") ~ "Violent",
                   TRUE ~ "random")) %>% 
  filter(offenseCat != "random")
```

Make the crime coordinates sf geometry points of the right coordinate system.

```{r}
minn_sf <- minneapolisCrime %>% 
  filter(Lat >0, Long <0) %>%
  st_as_sf(coords = c("Long", "Lat"), crs = "NAD83") %>%
  distinct()
```

Aggregate the points by census tract. 

```{r}
tract_points <- st_join(minn_sf, left = FALSE, gent_clean["tractmod"]) 
plot(tract_points$geometry, pch=21, cex=0.7, col="purple", bg="gray80")
plot(gent_clean$geometry, border="gray20", col=NA, add=T)

crimes_per_tract_no_geo <- tract_points %>%
  st_drop_geometry() %>%
  group_by(tractmod, year, offenseCat, .drop=FALSE) %>%
  count() %>%
  pivot_wider(names_from = year, values_from = n) %>%
  replace(is.na(.),0) %>%
  pivot_longer(cols = c(`2010`:`2022`),names_to = "year", values_to = "n") %>%
  pivot_wider(names_from = offenseCat, values_from = n) %>%
  filter(tractmod != 332)

tract_aggregated <- gent_clean %>%
  right_join(crimes_per_tract_no_geo, by = "tractmod") %>%
  mutate(violent_per_1000 = case_when(year %in% c(2010, 2011, 2012, 2013, 2014, 2015) ~ round((Violent/population_2010) * 1000,0),
                                      TRUE ~ round((Violent/population_2020) * 1000,0)), 
         theft_per_1000 = case_when(year %in% c(2010, 2011, 2012, 2013, 2014, 2015) ~ round((Theft/population_2010) * 1000,0),
                                      TRUE ~ round((Theft/population_2020) * 1000,0)))
```

Join crime data with `gent_clean` file.

```{r}
tract_points <- st_join(minn_sf, left = FALSE, gent_clean["tractmod"]) %>%
  st_join(gent_clean) %>%
  select(-tractmod.y) %>%
  rename("tract" = "tractmod.x") %>%
  filter(tract != 332)
```

Create additional file that removes auto thefts from the theft category.

```{r}
crimes_per_tract_no_auto <- tract_points %>%
  filter(Offense != "AUTOTH") %>%
  st_drop_geometry() %>%
  group_by(tract, year, offenseCat, .drop=FALSE) %>%
  count() %>%
  pivot_wider(names_from = year, values_from = n) %>%
  replace(is.na(.),0) %>%
  pivot_longer(cols = c(`2010`:`2022`),names_to = "year", values_to = "n") %>%
  pivot_wider(names_from = offenseCat, values_from = n) %>%
  filter(tract != 332)

tract_aggregated_no_auto <- gent_clean %>%
  right_join(crimes_per_tract_no_auto, by = c("tractmod" = "tract"))
```


```{r,eval=FALSE}
save(tract_aggregated, file = 'Data/CrimeCleaned/tract_aggregated_minneapolis.RData')
save(tract_points, file = "Data/CrimeCleaned/tract_points_minneapolis.RData")
save(tract_aggregated_no_auto, file = 'Data/CrimeCleaned/tract_aggregated_no_auto.RData')
```

## Cleaning saint paul crime data

Unlike the Minneapolis crime data, the Saint Paul data did not come with a latitude and longitude location of each crime. However, it did come with a rough block address or street intersection. Using GIS Pro we were able to get a rough latitude and longitude of each crime and then follow the same process as the Minneapolis data.

### Preparing the data for GIS 

First, identify crimes that occurred at intersections. These will need to be treated differently than those with addresses. Use string techniques to put them in a format that GIS likes. 

```{r, eval=FALSE}
intersections <- saintpaulcrime %>%
  select(BLOCK) %>%
  filter(str_detect(BLOCK, "&")) %>%
  count(BLOCK) %>%
  select(-n)

streets <- as.data.frame(str_split_fixed(intersections$BLOCK, ' & ', 2))
street_identifiers <- as.data.frame(str_split_fixed(streets$V1, " ", 2)) %>%
  #mutate(V2 = word(V2, 1)) %>% trying this out
  rename("street" = "V1", 
         "identifier" = "V2")
  
intersections_RamseyCo <- as.data.frame(str_split_fixed(intersections$BLOCK, ' & ', 2)) %>%
  left_join(street_identifiers, by = c("V2" = "street")) %>%
  mutate(V2 = paste(V2, identifier, sep= " ")) %>%
  select(-identifier) %>%
  rename("street1" = "V1", 
         "street2" = "V2") %>%
  mutate(street1 = str_trim(street1, side = c("right")), 
         street2 = str_trim(street2, side = "right")) %>%
  distinct_all() %>%
  mutate(combined = paste(street1, street2, sep = " & ")) %>%
  select(combined)
```

```{r, eval=FALSE}
write_csv(intersections_RamseyCo, "Data/Crime/intersections_RamseyCo.csv")
```

### Cleaning up GIS data 

Import data and select rough intersection and coordinates. There are 61591 intersection crimes in this dataset. 55826 intersections were given a latitude and longitude.

```{r}
intersections_ll <- read_csv("Data/Crime/intersections_RamseyCo_geocoded2.csv")
matched_lat_lngs <- intersections_ll %>%
  filter(Score > 0) %>%
  select(USER_combined, X, Y)
```

Create same intersection descriptions and make column `original` so we are able to join back to original data and get crime date and type. 

```{r}
all_intersections <- saintpaulcrime %>%
  filter(str_detect(BLOCK, "&")) %>%
  select(DATE, INCIDENT, BLOCK)

streets <- as.data.frame(str_split_fixed(all_intersections$BLOCK, ' & ', 2)) 
streets2 <- bind_cols(streets, all_intersections)
street_identifiers <- as.data.frame(str_split_fixed(streets2$V1, " ", 2)) %>%
  mutate(V2 = word(V2, 1)) %>% 
  rename("street" = "V1", 
         "identifier" = "V2")

#problem: streets have different identifiers, causing multiple crimes
street_identifiers %>%
  distinct() %>%
  group_by(street) %>%
  mutate(count = n()) %>%
  filter(count>=2) %>%
  arrange(desc(count), street)

#best solution: take the most often identifier and remove other identifiers. This will make certain areas slightly short of crimes but prevents extreme double/triple/quadrouple counting.
street_identifiers2 <- street_identifiers %>%
  group_by(street) %>%
  count(identifier) %>%
  mutate(most_often_identifier = max(n)) %>%
  filter(most_often_identifier == n) %>%
  select(-n, -most_often_identifier)

intersections_clean <- streets2 %>%
  left_join(street_identifiers2, by = c("V2" = "street")) %>%
  distinct() %>%
  mutate(V2 = paste(V2, identifier, sep= " ")) %>%
  select(-identifier) %>%
  rename("street1" = "V1", 
         "street2" = "V2") %>%
  mutate(street1 = str_trim(street1, side = c("right")), 
         street2 = str_trim(street2, side = "right")) %>%
  mutate(combined = paste(street1, street2, sep = " & ")) 
```

```{r}
intersection_crimes <- intersections_clean %>%
  left_join(matched_lat_lngs, by = c("combined" = "USER_combined")) %>%
  distinct(DATE, X, Y, INCIDENT) %>%
  na.omit() %>%
  rename("longitude" = "X", 
         "latitude" = "Y") %>%
  mutate(year = as.numeric(substr(DATE,1, 4)))
```
