---
title: "Saint Paul Crime"
author: "Erin Franke"
date: "2023-03-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(tidygeocoder)
saintpaulcrime <- read_csv("Data/Crime/Crime_Incident_Report_2023.csv")
```

This is the 6th file in my data cleaning process and works on converting the Saint Paul data to coordinates. 

First, get types of crime of interest: there are 185,415 observations from 2015-2022.

```{r}
saintpaulcrime <- saintpaulcrime %>%
  mutate(year = as.numeric(substr(DATE, 1, 4))) %>%
  filter(year != 2014, year!=2023) %>%
  mutate(OffenseCat = case_when(INCIDENT %in% c("Theft", "Burglary", "Vandalism", "Narcotics", "Criminal Damage", "Graffiti", "THEFT") ~ "Theft", 
                                INCIDENT == "Auto Theft" ~ "Auto Theft",
                                INCIDENT %in% c("Simple Asasult Dom.", "Robbery", "Agg. Assault", "Agg. Assault Dom.", "Rape", "Arson", "Simple Assault Dom.", "Simple Assault Dom", "Homicide", "Agg. Assault Dom") ~ "Violent", 
                                TRUE ~ "random")) %>%
  filter(OffenseCat != "random")
```

We got rid of the following types of offenses

```{r}
read_csv("Data/Crime/Crime_Incident_Report_2023.csv") %>%
  mutate(year = as.numeric(substr(DATE, 1, 4))) %>%
  filter(year != 2014, year!=2023) %>%
  mutate(OffenseCat = case_when(INCIDENT %in% c("Theft", "Burglary", "Vandalism", "Narcotics", "Criminal Damage", "Graffiti", "THEFT") ~ "Theft", 
                                INCIDENT == "Auto Theft" ~ "Auto Theft",
                                INCIDENT %in% c("Simple Asasult Dom.", "Robbery", "Agg. Assault", "Agg. Assault Dom.", "Rape", "Arson", "Simple Assault Dom.", "Simple Assault Dom", "Homicide", "Agg. Assault Dom") ~ "Violent", 
                                TRUE ~ "random")) %>%
  filter(OffenseCat == "random") %>%
  count(INCIDENT)
```

Count number of crimes occurring at an intersection: 18,894.

```{r}
saintpaulcrime %>%
  filter(str_detect(BLOCK, " & ")| str_detect(BLOCK, " AND ")) %>%
  count()
```

Remainder of crimes (166,521). Filter out intersections, replace X in street address with 0. Fix multiple word streets. 

```{r}
sp <- saintpaulcrime %>%
  filter(!str_detect(BLOCK, " & "), !str_detect(BLOCK, " AND ")) %>%
  mutate(street_address = word(BLOCK, 1),
         street_address = str_replace(street_address, "X", "0"))
sp$BLOCK <- sapply(sapply(strsplit(sp$BLOCK, split = ' '), function(x) x[2:length(x)]), paste, collapse = ' ')
  
sp <- sp %>%
  mutate(BLOCK = str_replace(BLOCK, "OLDHUDSON", "OLD HUDSON"), 
         BLOCK = str_replace(BLOCK, "ANNARBOR", "ANN ARBOR"), 
         BLOCK = str_replace(BLOCK, "BARGECHANNEL", "BARGE CHANNEL"), 
         BLOCK = str_replace(BLOCK, "BATTLECREEK", "BATTLE CREEK"), 
         BLOCK = str_replace(BLOCK, "CESARCHAVEZ", "CESAR CHAVEZ"), 
         BLOCK = str_replace(BLOCK, "CHEROKEEHTS", "CHEROKEE HTS"), 
         BLOCK = str_replace(BLOCK, "CROCUSHILL", "CROCUS HILL"), 
         BLOCK = str_replace(BLOCK, "CROSBYFARM", "CROSBY FARM"), 
         BLOCK = str_replace(BLOCK, "CROSBYLAKE", "CROSBY LAKE"),
         BLOCK = str_replace(BLOCK, "DANPATCH", "DAN PATCH"), 
         BLOCK = str_replace(BLOCK, "DOROTHYDAY", "DOROTHY DAY"),
         BLOCK = str_replace(BLOCK, "DRJUSTUSOHAGE", "DR JUSTUS OHAGE"), 
         BLOCK = str_replace(BLOCK, "EDGCUMBE", "EDGECUMBE"), 
         BLOCK = str_replace(BLOCK, "ENERGYPARK", "ENERGY PARK"), 
         BLOCK = str_replace(BLOCK, "GRANDHILL", "GRAND HILL"), 
         BLOCK = str_replace(BLOCK, "HARDENBERGH", "HARDEN BERGH"), 
         BLOCK = str_replace(BLOCK, "HARRIETISLAND", "HARRIET ISLAND"), 
         BLOCK = str_replace(BLOCK, "HIDDENFALLS", "HIDDEN FALLS"), 
         BLOCK = str_replace(BLOCK, "HUNTINGVALLEY", "HUNTING VALLEY"), 
         BLOCK = str_replace(BLOCK, "IVANWAY", "IVAN WAY"),
         BLOCK = str_replace(BLOCK, "JEFFERSONCOMMONS", "JEFFERSON COMMONS"), 
         BLOCK = str_replace(BLOCK, "JOHNIRELAND", "JOHN IRELAND"), 
         BLOCK = str_replace(BLOCK, "LAFAYETTEFRONTAGE", "LAFAYETTE FRONTAGE"), 
         BLOCK = str_replace(BLOCK, "LARRYHO", "LARRY HO"), 
         BLOCK = str_replace(BLOCK, "LOWERAFTON", "LOWER AFTON"), 
         BLOCK = str_replace(BLOCK, "LOWERSTDENNIS", "LOWER ST DENNIS"), 
         BLOCK = str_replace(BLOCK, "LYNNHURST", "LYNN HURST"), 
         BLOCK = str_replace(BLOCK, "MARTINLUTHERKING", "MARTIN LUTHER KING"), 
         BLOCK = str_replace(BLOCK, "MISSISSIPPIRIVER", "MISSISSIPPI RIVER"), 
         BLOCK = str_replace(BLOCK, "MORNINGSIDE", "MORNING SIDE"), 
         BLOCK = str_replace(BLOCK, "MTAIRY", "MT AIRY"), 
         BLOCK = str_replace(BLOCK, "MTCURVE", "MT CURVE"), 
         BLOCK = str_replace(BLOCK, "OLDSIXTH", "OLD SIXTH"), 
         BLOCK = str_replace(BLOCK, "OTTOHUMMER", "OTTO HUMMER"), 
         BLOCK = str_replace(BLOCK, "PIERCEBUTLER", "PIERCE BUTLER"),
         BLOCK = str_replace(BLOCK, "PIGSEYELAKE", "PIGSEYE LAKE"), 
         BLOCK = str_replace(BLOCK, "PTDOUGLAS", "PT DOUGLAS"), 
         BLOCK = str_replace(BLOCK, "RIVERPARK", "RIVER PARK"), 
         BLOCK = str_replace(BLOCK, "SPRUCETREE", "SPRUCE TREE"), 
         BLOCK = str_replace(BLOCK, "STANTHONY", "ST ANTHONY"), 
         BLOCK = str_replace(BLOCK, "STALBANS", "ST ALBANS"), 
         BLOCK = str_replace(BLOCK, "STCLAIR", "ST CLAIR"), 
         BLOCK = str_replace(BLOCK, "STDENNIS", "ST DENNIS"), 
         BLOCK = str_replace(BLOCK, "STPAUL", "ST PAUL"), 
         BLOCK = str_replace(BLOCK, "STPETER", "ST PETER"), 
         BLOCK = str_replace(BLOCK, "TROUTBROOK", "TROUT BROOK"), 
         BLOCK = str_replace(BLOCK, "UPPERAFTON", "UPPER AFTON"), 
         BLOCK = str_replace(BLOCK, "UPPERSTDENNIS", "UPPER ST DENNIS"), 
         BLOCK = str_replace(BLOCK, "VANBUREN", "VAN BUREN"),
         BLOCK = str_replace(BLOCK, "VANSLYKE", "VAN SLYKE"), 
         BLOCK = str_replace(BLOCK, "WHEELOCKRIDGE", "WHEELOCK RIDGE"), 
         BLOCK = str_replace(BLOCK, "WHITEBEAR", "WHITE BEAR"), 
         BLOCK = str_replace(BLOCK, "WILLIAMTELL", "WILLIAM TELL"), 
         BLOCK = str_replace(BLOCK, "YACHTCLUB", "YACHT CLUB"), 
         BLOCK = str_replace(BLOCK, " BD", " BLVD"),
         BLOCK = str_replace(BLOCK, " PK", " PKWY")) %>%
  mutate(address = paste(street_address, BLOCK))
```

Run this cleaned set of addresses through the geocoder. We get 124,140 crimes. Thus 42,381 still are missing coordinates. 

```{r, eval=FALSE}
blocksLatLng <- sp %>%
  mutate(address = paste0(address, ", Saint Paul, MN")) %>%
  tidygeocoder::geocode(address, method = 'osm', lat = latitude, long = longitude)

save(blocksLatLng, file = "Data/CrimeCleaned/blocksLatLng.RData")
```

```{r}
load("Data/CrimeCleaned/blocksLatLng.RData")
missing <- blocksLatLng %>%
  filter(is.na(latitude))
cleaned <- blocksLatLng %>%
  filter(!is.na(latitude))
```

I realized that the initial issue in the data was PA, not PK. Run these through the geocoder. This gets us another 1,391 addresses.

```{r, eval=FALSE}
blocksLatLngPA <- blocksLatLng %>%
  filter(is.na(latitude)) %>%
  filter(str_detect(address, " PA ")) %>%
  mutate(address = str_replace(address, " PA ", " PKWY ")) %>%
  select(-latitude, -longitude) %>%
  tidygeocoder::geocode(address, method = 'osm', lat = latitude, long = longitude)

save(blockLatLngPA, file = "Data/CrimeCleaned/blocksLatLngPA.RData")
```

```{r}
load("Data/CrimeCleaned/blocksLatLngPA.RData")
cleanPA <- blocksLatLngPA %>%
  filter(!is.na(latitude))
missingPA <- blocksLatLngPA %>%
  filter(is.na(latitude))

cleaned <- cleaned %>%
  rbind(cleanPA)
missing <- missing %>%
  filter(!(CASE_NUMBER %in% cleanPA$CASE_NUMBER))
```

For some of the addresses, it requires the direction (N, W, E, S) to be before the street name. 

```{r}
rearranged <- missing %>%
  filter(str_detect(address, "E, Saint Paul, MN")| str_detect(address, "E, Saint Paul, MN")| str_detect(address, "N, Saint Paul, MN")| str_detect(address, "S, Saint Paul, MN")) %>%
  select(-latitude, -longitude) %>%
  mutate(number = word(address, 1), 
         direction = word(address, -4),
         direction = str_replace(direction, ",", ""), 
         address2 = paste0(number, " ", direction, " ", word(address, 2, 3), ", ", "Saint Paul, MN")) %>%
  mutate(address2 = str_replace(address2, "MISSISSIPPI RIVER", " MISSISSIPPI RIVER BLVD"))

rearrangedLatLng <- rearranged %>%
  geocode(address2, method = "osm", lat = latitude, long = longitude)
save(rearrangedLatLng, file = "Data/CrimeCleaned/rearrangedLatLng.RData")
```

I accidentally did two "E" instead of "W" above, so do the same thing for "W" addresses. Don't judge, it takes a long time to run on the geocoder so I am not gonnna rerun them all when I don't have to.

```{r}
rearrangedW <- missing %>%
  filter(str_detect(address, "W, Saint Paul, MN")) %>%
  select(-latitude, -longitude) %>%
  mutate(number = word(address, 1), 
         direction = word(address, -4),
         direction = str_replace(direction, ",", ""), 
         address2 = paste0(number, " ", direction, " ", word(address, 2, 3), ", ", "Saint Paul, MN")) %>%
  mutate(address2 = str_replace(address2, "MISSISSIPPI RIVER", " MISSISSIPPI RIVER BLVD"))

rearrangedLatLngW <- rearrangedW %>%
  geocode(address2, method = "osm", lat = latitude, long = longitude)
save(rearrangedLatLngW, file = "Data/CrimeCleaned/rearrangedLatLngW.RData")
```

Rearranging allowed us to bring our total number of missing addresses down to 28,589. We got 12,401 from doing this (pretty good).

```{r}
load("Data/CrimeCleaned/rearrangedLatLngW.RData")
load("Data/CrimeCleaned/rearrangedLatLng.RData")

rearrangedLatLng <- rbind(rearrangedLatLng, rearrangedLatLngW) %>%
  select(-address2, -number, -direction)

cleanRearranged <- rearrangedLatLng %>%
  filter(!is.na(latitude))
missingRearranged <- rearrangedLatLng %>%
  filter(is.na(latitude))

cleaned <- cleaned %>%
  rbind(cleanRearranged)
missing <- missing %>%
  filter(!(CASE_NUMBER %in% cleanRearranged$CASE_NUMBER))
```

It looks like sometimes the geocoder prefers "AVE" to "AV". But not always? Very strange in my opinion. Replace this and rerun through geocoder. Also found an error with a particular street so fixing that. 

```{r}
weirdAVE <- missing %>%
  filter(str_detect(address, " AV,")| str_detect(address, "ST ANTHONY")) %>%
  mutate(address = str_replace(address, " AV,", " AVE,"), 
         address = str_replace(address, "ST ANTHONY", "ANTHONY")) 

weirdLatLngAVE <- weirdAVE %>%
  geocode(address, method = "osm", lat = latitude, long = longitude)
save(weirdLatLngAVE, file = "Data/CrimeCleaned/weirdLatLngAVE.RData")
```

```{r}
load("Data/CrimeCleaned/weirdLatLngAVE.RData")

weirdLatLngAVE <- weirdLatLngAVE %>%
  select(-latitude...18, -longitude...19) %>%
  rename("latitude" = "latitude...20", 
         "longitude" = "longitude...21")

cleanAVE <- weirdLatLngAVE %>%
  filter(!is.na(latitude))
missingAVE <- weirdLatLngAVEg %>%
  filter(is.na(latitude))

cleaned <- cleaned %>%
  rbind(cleanAVE)
missing <- missing %>%
  filter(!(CASE_NUMBER %in% cleanAVE$CASE_NUMBER)) %>%
  mutate(address = str_replace(address, " PA,", " PKWY,")) #add in this
```

Something I noticed is that some streets don't have directions. For example, "1810 E MECHANIC AV, Saint Paul, MN" works but the original "1810 MECHANIC AV, Saint Paul, MN" does not. We don't know what direction the street should have can try I guess. 

```{r}
directionE <- missing %>%
  filter(!str_detect(address, " W, Saint Paul, MN"), !str_detect(address, " E, Saint Paul, MN"), !str_detect(address, " N, Saint Paul, MN"), !str_detect(address, " S, Saint Paul, MN")) %>%
  mutate(street_address = word(address, 1), 
         address = paste(street_address, "E", word(address, 2, -1)))

directionELL <- directionE %>%
  geocode(address, method = "osm", lat = latitude, long = longitude)
save(directionELL, file = "Data/CrimeCleaned/directionELL.RData")
```

The remaining addresses make me sad and I think at this point it's time to give up or I'll be here forever.

Gather intersections. We are able to get 8,165 out of 18,894 (43.2%)

```{r}
intersections<- read_csv("Data/Crime/intersections_RamseyCo_geocoded2.csv") %>%
  filter(Score > 0) %>%
  select(USER_combined, X, Y)
intersections$USER_combined <- sapply(sapply(strsplit(intersections$USER_combined, split = ' '), function(x) x[1:length(x)-1]), paste, collapse = ' ')

saintpaulcrime %>%
  filter(str_detect(BLOCK, " AND ")|str_detect(BLOCK, " & ")) %>%
  mutate(BLOCK = str_replace(BLOCK, " AND ", " & ")) %>%
  left_join(intersections, by = c("BLOCK" = "USER_combined")) %>%
  filter(!is.na(X))
```



