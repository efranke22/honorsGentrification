---
title: "Crime Exploratory Data Analysis"
author: "Erin Franke"
date: "2022-10-06"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Data Loading 

```{r}
# Libraries 
library(tidyverse)
library(NatParksPalettes)
library(PrettyCols)
library(ggmap)
library(sf)

load('Data/gent_clean.RData')

#Minneapolis
load('Data/CrimeCleaned/tract_aggregated_minneapolis.RData')
load('Data/CrimeCleaned/tract_points_minneapolis.RData')
load("Data/CrimeCleaned/tract_aggregated_minneapolis_violent.RData")
load("Data/CrimeCleaned/tract_aggregated_minneapolis_theft.RData")
load("Data/CrimeCleaned/tract_aggregated_minneapolis_autotheft.RData")


#Saint Paul
load('Data/CrimeCleaned/tract_aggregated_sp.RData')
load("Data/CrimeCleaned/tract_points_sp.RData")
load("Data/CrimeCleaned/tract_aggregated_sp_violent.RData")
load("Data/CrimeCleaned/tract_aggregated_sp_theft.RData")
load("Data/CrimeCleaned/tract_aggregated_sp_autotheft.RData")
```

# EDA - Minneapolis

Explore year distribution of crimes in Minneapolis.

```{r}
tract_aggregated %>%
  filter(year == 2010) %>%
  ggplot()+
  geom_sf(aes(fill = crimes_per_1000d))+
  theme_classic()+
  scale_fill_natparks_d(name = "Olympic")+
  labs(title = "Crimes per 1000 residents in 2010 \nby Minneapolis census tract", fill = "")+
  theme(plot.title.position = "plot", 
        plot.title = element_text(family = "mono", size = 10), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(), 
        axis.line = element_blank())

tract_aggregated %>%
  filter(year == 2021) %>%
  ggplot()+
  geom_sf(aes(fill = crimes_per_1000d))+
  theme_classic()+
  scale_fill_natparks_d(name = "Olympic")+
  labs(title = "Crimes per 1000 residents in 2021 \nby Minneapolis census tract", fill = "")+
  theme(plot.title.position = "plot", 
        plot.title = element_text(family = "mono", size = 10), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(), 
        axis.line = element_blank())

tract_aggregated_violent %>%
  filter(year %in% c(2010, 2021)) %>%
  mutate(crimes_per_1000 = round((n/population_2020) * 1000, 0),
         crimes_per_1000d = as.factor(case_when(crimes_per_1000 <=2 ~ "0.1-2", 
                                      crimes_per_1000 >2 & crimes_per_1000 <= 4 ~ "3-4", 
                                      crimes_per_1000 > 4 & crimes_per_1000 <= 7 ~ "5-7", 
                                      crimes_per_1000 >7 & crimes_per_1000 <= 11 ~ "8-11", 
                                      TRUE ~ "12+")),
         crimes_per_1000d = fct_relevel(crimes_per_1000d, levels = c("0.1-2", "3-4", "5-7", "8-11", "12+"))) %>%
  ggplot()+
  geom_sf(aes(fill = crimes_per_1000d))+
  theme_classic()+
  facet_wrap(~year)+
  scale_fill_natparks_d(name = "Olympic")+
  labs(title = "Crimes per 1000 residents in 2021 \nby Minneapolis census tract", fill = "")+
  theme(plot.title.position = "plot", 
        plot.title = element_text(family = "mono", size = 10), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(), 
        axis.line = element_blank())
```

```{r}
ggplot() +
  geom_sf(data=tract_aggregated %>% filter(year <= 2016), aes(fill=crimes_per_1000d), lwd=0.4, alpha =0.8)+
  theme_classic()+
  facet_wrap(~year)+
  scale_fill_natparks_d(name = "Olympic")+
  labs(title = "Crimes per 1000 people by Minneapolis census tract 2022", fill = "")+
  theme(plot.title.position = "plot", 
        plot.title = element_text(family = "mono", size = 9), 
        axis.line = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank())

ggplot() +
  geom_sf(data=tract_aggregated %>% filter(year > 2016), aes(fill=crimes_per_1000d), lwd=0.4, alpha =0.8)+
  theme_classic()+
  facet_wrap(~year)+
  scale_fill_natparks_d(name = "Olympic")+
  labs(title = "Crimes per 1000 people by Minneapolis census tract 2022", fill = "")+
  theme(plot.title.position = "plot", 
        plot.title = element_text(family = "mono", size = 9), 
        axis.line = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank())
```

Look at overall trend in number of crimes per year.

```{r}
tract_points %>%
  count(year) %>%
  ggplot(aes(x=year, y=n))+
  geom_point()+
  geom_line()+
  ylim(c(5000, 25000))+
  scale_x_continuous(breaks = c(2010, 2012, 2014, 2016, 2018, 2020, 2022))+
  theme_classic()+
  labs(x="Year", y= "", title = "Number of Recorded Minneapolis Crimes by Year")+
  theme(plot.title.position = "plot", 
        plot.title = element_text(family = "mono", size =10), 
        axis.title.x = element_text(family = "mono"))
```

Create groups of offenses and plot trends over years. \
- Theft: THEFT, BIKETF, TFPER, THFTSW, PKGTHEFT \
- Autotheft: TFMV, AUTOTH, TMVP, CARJCK, MVTHFT \
- Home burglary: BURGD \
- Business burglary: BURGB, ROBBIZ, TBLDG \
- Assault: ASLT2, CSCR, DASTR, DASLT2, ASLT3, ASLT4, DASLT3, MURDR,ASLT1, DASLT1 \

```{r}
tract_points <- tract_points %>%
  mutate(offense_group = case_when(Offense %in% c("THEFT", "BIKETF", "TFPER", "THFTSW", "PKGTHEFT") ~ "Theft", 
                                   Offense %in% c("TFMV", "AUTOTH", "TMVP", "CARJCK", "MVTHFT") ~ "Auto Theft",
                                   Offense == "BURGD" ~ "Home Burglary", 
                                   Offense %in% c("BURGB", "ROBBIZ", "TBLDG") ~ "Business Burglary", 
                                   Offense %in% c("ASLT2", "CSCR", "DASTR", "DASLT2", "ASLT3", "ASLT4", "DASLT3", "MURDR", "ASLT1", "DASLT1") ~ "Assault", 
                                   TRUE ~ "Other"))
tract_points %>%
  count(year, offense_group) %>%
  filter(offense_group != "Other") %>%
  ggplot(aes(x=year, y=n, color = offense_group))+
  geom_point()+
  geom_line()+
  theme_classic()+
  labs(x="Year", y= "", title = "Number of Recorded Minneapolis Crimes by Year", color = "Crime category")+
  theme(plot.title.position = "plot", 
        plot.title = element_text(family = "mono", size =12), 
        axis.title.x = element_text(family = "mono"), 
        legend.title = element_text(family = "mono"))+
  scale_x_continuous(breaks = c(2010, 2012, 2014, 2016, 2018, 2020, 2022))+
  scale_color_natparks_d(name = "SmokyMtns")
```

Understanding crimes by tract gentrification category. 

```{r}
#number of census tracts by canGent and typical population size
tract_aggregated %>%
  distinct(tract, canGent, population_2010, freeman) %>%
  ungroup() %>%
  group_by(canGent, freeman) %>%
  summarize(numtract = n(), avg_pop = mean(population_2010))

tract_points %>%
  count(tract, canGent, freeman, year) %>%
  group_by(year, canGent, freeman) %>%
  summarize(totalCrimes = sum(n)) %>%
  mutate(gent_cat = case_when(freeman == "1" & canGent == "1" ~ "Gentrified", 
                              freeman == "0" & canGent == "1" ~ "Did not gentrify", 
                              TRUE ~ "Not gentrifiable")) %>%
  mutate(crimes_per_1000 = case_when(canGent == "1" & freeman == "1" ~ totalCrimes/(46*3175)*1000, 
                                     canGent == "1" & freeman == "0" ~ totalCrimes/(41*4032)*1000,
                                     TRUE ~ totalCrimes/(43*3635)*1000)) %>%
  ggplot(aes(x=year, y=crimes_per_1000, color = gent_cat))+
  geom_point()+
  geom_line()+
  theme_classic()+
  labs(x="Year", y= "Annual crimes/1000 people", title = "Crime patterns by census tract gentrification category", color = "Tract category")+
  theme(plot.title.position = "plot", 
        plot.title = element_text(family = "mono", size =10), 
        axis.title.x = element_text(family = "mono"), 
        legend.title = element_text(family = "mono"), 
        axis.title.y = element_text(family = "mono"))+
  scale_x_continuous(breaks = c(2010, 2012, 2014, 2016, 2018, 2020, 2022))+
  scale_color_natparks_d(name = "SmokyMtns")

tract_aggregated %>%
  distinct(tract, canGent, population_2010, ding) %>%
  ungroup() %>%
  group_by(canGent, ding) %>%
  summarize(numtract = n(), avg_pop = mean(population_2010))

tract_points %>%
  count(tract, canGent, ding, year) %>%
  group_by(year, canGent, ding) %>%
  summarize(totalCrimes = sum(n)) %>%
  mutate(gent_cat = case_when(ding == "1" & canGent == "1" ~ "Gentrified", 
                              ding == "0" & canGent == "1" ~ "Did not gentrify", 
                              TRUE ~ "Not gentrifiable")) %>%
  mutate(crimes_per_1000 = case_when(canGent == "1" & ding == "1" ~ totalCrimes/(27*3068)*1000, 
                                     canGent == "1" & ding == "0" ~ totalCrimes/(60*3809)*1000,
                                     TRUE ~ totalCrimes/(43*3635)*1000)) %>%
  ggplot(aes(x=year, y=crimes_per_1000, color = gent_cat))+
  geom_point()+
  geom_line()+
  theme_classic()+
  labs(x="Year", y= "Annual crimes/1000 people", title = "Crime patterns by census tract gentrification category", color = "Tract category")+
  theme(plot.title.position = "plot", 
        plot.title = element_text(family = "mono", size =10), 
        axis.title.x = element_text(family = "mono"), 
        legend.title = element_text(family = "mono"), 
        axis.title.y = element_text(family = "mono"))+
  scale_x_continuous(breaks = c(2010, 2012, 2014, 2016, 2018, 2020, 2022))+
  scale_color_natparks_d(name = "SmokyMtns")
```

## Exploratory Data Analysis - Saint Paul

Explore year distribution of crimes in Minneapolis.

```{r}
ggplot() +
  geom_sf(data=tract_aggregated_sp, aes(fill=crimes_per_1000d), lwd=0.4, alpha =0.8)+
  theme_classic()+
  facet_wrap(~year)+
  scale_fill_natparks_d(name = "Olympic")+
  labs(title = "Crimes per 1000 people by Saint Paul census tract 2022", fill = "")+
  theme(plot.title.position = "plot", 
        plot.title = element_text(family = "mono", size = 9), 
        axis.line = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank())
```

Look at overall trend in number of crimes per year.

```{r}
tract_points_sp %>%
  count(year) %>%
  ggplot(aes(x=year, y=n))+
  geom_point()+
  geom_line()+
  ylim(c(5000, 40000))+
  scale_x_continuous(breaks = c(2014, 2016, 2018, 2020, 2022))+
  theme_classic()+
  labs(x="Year", y= "", title = "Number of Recorded Saint Paul Crimes by Year")+
  theme(plot.title.position = "plot", 
        plot.title = element_text(family = "mono", size =10), 
        axis.title.x = element_text(family = "mono"))
```



